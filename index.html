<!DOCTYPE html>
<html lang="fi">
<head>
    <title>Leaflet Tram Directions</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.10.3/mqtt.min.js"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* Custom styles for tram marker */
        .my-div-icon {
            position: relative;
            width: 50px;
            height: 50px;
        }

        .my-div-icon img {
            width: 100%;
            height: 100%;
            transform-origin: center; /* Rotate around the center */
            transform: rotate(0deg); /* Default rotation */
        }

        .my-div-icon .tram-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-align: center;
            pointer-events: none; /* Ensure it doesnâ€™t block interactions */
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="filter"
     style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border: 1px solid #ccc;">
    <h3>Filter Tram Lines</h3>
    <label><input type="checkbox" class="tram-filter" value="1" checked autocomplete="off"> Tram Line 1</label><br>
    <label><input type="checkbox" class="tram-filter" value="2" checked autocomplete="off"> Tram Line 2</label><br>
    <label><input type="checkbox" class="tram-filter" value="3" checked autocomplete="off"> Tram Line 3</label><br>
    <label><input type="checkbox" class="tram-filter" value="4" checked autocomplete="off"> Tram Line 4</label><br>
    <label><input type="checkbox" class="tram-filter" value="5" checked autocomplete="off"> Tram Line 5</label><br>
    <label><input type="checkbox" class="tram-filter" value="6" checked autocomplete="off"> Tram Line 6</label><br>
    <label><input type="checkbox" class="tram-filter" value="7" checked autocomplete="off"> Tram Line 7</label><br>
    <label><input type="checkbox" class="tram-filter" value="8" checked autocomplete="off"> Tram Line 8</label><br>
    <label><input type="checkbox" class="tram-filter" value="9" checked autocomplete="off"> Tram Line 9</label><br>
    <label><input type="checkbox" class="tram-filter" value="10" checked autocomplete="off"> Tram Line 10</label><br>
    <label><input type="checkbox" class="tram-filter" value="13" checked autocomplete="off"> Tram Line 13</label><br>
    <label><input type="checkbox" class="tram-filter" value="15" checked autocomplete="off"> Tram Line 15</label><br>
    <hr/>
    <label><input id="deselect-all" type="checkbox" autocomplete="off">deselect all</label>
</div>

<script>
    const map = L.map('map').setView([60.18, 24.95], 13);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    function createTramMarker(lat, lng, direction, tramLine) {
        const icon = L.divIcon({
            className: 'my-div-icon',
            html: `
                <img src="circle_with_caret_small.png" style="transform: rotate(${direction}deg);">
                <div class="tram-line">${tramLine}</div>
            `,
            iconSize: [50, 50], // Match the size of the PNG
            iconAnchor: [25, 50], // Anchor at the center
        });

        const marker = L.marker([lat, lng], {icon}).addTo(map);
        return marker;
    }

    const tramMarkers = {}

    const client = mqtt.connect("wss://mqtt.hsl.fi:443", {clean: true, connectTimeout: 4000})

    client.on("connect", () => {
        console.log("Connected")
        client.subscribe("/hfp/v2/journey/ongoing/vp/tram/+/+/+/+/+/+/+/4/#", (err) => {
            if (err) {
                console.log("Error subscribing: ", err)
            }
        })
    })

    client.on("message", (topic, message) => {
        const payload = JSON.parse(message.toString()).VP
        setData(payload)
        // client.end()
    })

    function setData(payload) {
        const {lat, long, hdg, desi, veh} = payload; // `desi` is the tram line
        if (!lat || !long) return;

        if (!tramMarkers[veh]) {
            tramMarkers[veh] = {
                marker: createTramMarker(lat, long, hdg, desi),
                tramLine: desi,
            };
        } else {
            tramMarkers[veh].marker.setLatLng([lat, long]);
            try {
                const img = tramMarkers[veh].marker._icon.querySelector('img');
                if (img) img.style.transform = `rotate(${hdg}deg)`;
            } catch (err) {
            }
        }
    }

    function updateFilters() {
        const visibleLines = Array.from(document.querySelectorAll('.tram-filter:checked'))
            .map(input => input.value);

        for (const veh in tramMarkers) {
            const {marker, tramLine} = tramMarkers[veh];
            if (visibleLines.includes(tramLine)) {
                map.addLayer(marker); // Show marker
            } else {
                map.removeLayer(marker); // Hide marker
            }
        }
    }

    document.querySelectorAll('.tram-filter').forEach(input => {
        input.addEventListener('change', updateFilters);
    });

    document.querySelector("#deselect-all").addEventListener("change", (e) => {
        document.querySelectorAll('.tram-filter').forEach(input => {
            input.checked = !e.target.checked;
        });
        updateFilters();
    });


    /* Payload example

        {
          "desi": "15",  // Tram line number
          "dir": "2",
          "oper": 40,
          "veh": 99958,  // Vehicle ID
          "tst": "2025-01-16T11:58:21.251Z",
          "tsi": 1737028701,
          "spd": null,
          "hdg": null,  // Heading in degrees
          "lat": null,
          "long": null,
          "acc": null,
          "dl": -1466120,
          "odo": null,
          "drst": null,
          "oday": "2024-12-30",
          "jrn": 545,
          "line": 1142,
          "start": "14:43",
          "loc": "GPS",
          "stop": null,
          "route": "2015",
          "occu": 0
        }

    */

</script>
</body>
</html>
